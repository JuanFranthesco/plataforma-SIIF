<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Materiais - SIIF</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="role-user">
    <div class="page-container">

        {% include 'header.html' %}

        <!-- CONTEÚDO -->
        <main id="conteudo">
            <div class="container-fluid">

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"
                                        aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- FILTRO / PESQUISA / ADICIONAR MATERIAL -->
                <div class="row g-4 mb-4">

                    <div class="col-lg-4 col-md-6">
                        <section class="filter-panel card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title filter-title">Filtrar Materiais</h2>

                                <form class="d-flex gap-2" method="GET"
                                      action="{{ url_for('main.tela_materiais') }}">
                                    <div class="flex-grow-1">
                                        <select id="filtro-categoria" name="categoria" class="form-select">
                                            <option value="">Todas as Categorias...</option>

                                            {% for cat in categorias %}
                                            <option value="{{ cat }}"
                                                {% if cat == categoria_selecionada %}selected{% endif %}>
                                                {{ cat }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <button type="submit" class="btn btn-primary filter-btn">Filtrar</button>
                                </form>
                            </div>
                        </section>
                    </div>

                    <div class="col-lg-5 col-md-6">
                        <section class="search-panel-material card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title search-title">Pesquisar Material</h2>

                                <form class="search-form-material" method="GET"
                                      action="{{ url_for('main.tela_materiais') }}">
                                    <input type="search" id="buscar" name="q"
                                           value="{{ termo_pesquisado or '' }}"
                                           class="form-control search-input-material"
                                           placeholder="Digite o nome do material, disciplina..." />

                                    <button type="submit" class="btn btn-search-material">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </form>
                            </div>
                        </section>
                    </div>

                    <div class="col-lg-3 col-md-12">
                        <section class="card shadow-sm h-100">
                            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                <h2 class="card-title search-title text-center">Contribuir com a Comunidade</h2>

                                <button type="button" class="btn btn-primary w-100 filter-btn"
                                        data-bs-toggle="modal" data-bs-target="#modalAdicionarMaterial">
                                    <i class="bi bi-plus-circle-fill"></i> Adicionar Material
                                </button>
                            </div>
                        </section>
                    </div>

                </div>

                <!-- LISTA DE MATERIAIS -->
                <section class="materials-section">
                    <h2 class="section-title">Materiais Disponíveis</h2>

                    {% if materiais_agrupados %}
                        {% for categoria, materiais in materiais_agrupados.items() %}

                        <div class="material-group card shadow-sm mb-4">

                            <div class="card-header material-group-header d-flex justify-content-between">
                                <h3 class="mb-0"><i class="bi bi-folder-fill"></i> {{ categoria }}</h3>

                                <button class="btn btn-sm btn-danger admin-only">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>

                            <div class="list-group list-group-flush">

                                {% for material in materiais %}
                                <div class="material-item list-group-item">

                                    <div class="material-subitem d-flex justify-content-between align-items-center">

                                        <span>
                                            {% if '.pdf' in material.arquivo_path.lower() %}
                                            <i class="bi bi-filetype-pdf text-danger"></i>
                                            {% elif '.zip' in material.arquivo_path.lower() %}
                                            <i class="bi bi-file-earmark-zip-fill"></i>
                                            {% else %}
                                            <i class="bi bi-file-earmark-text-fill"></i>
                                            {% endif %}

                                            <strong>{{ material.titulo }}</strong>

                                            {% if material.descricao %}
                                            <small class="d-block text-muted">{{ material.descricao }}</small>
                                            {% endif %}
                                        </span>

                                        <div class="d-flex gap-2">

                                            <a href="{{ url_for('main.download_material', material_id=material.id) }}"
                                               class="btn btn-sm access-button" target="_blank">
                                                Acessar <i class="bi bi-download"></i>
                                            </a>

                                            <form action="{{ url_for('main.excluir_material', material_id=material.id) }}"
                                                  method="POST" class="admin-only d-inline"
                                                  onsubmit="return confirm('Tem certeza que deseja excluir?');">

                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash-fill"></i>
                                                </button>
                                            </form>

                                        </div>
                                    </div>

                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        {% endfor %}

                    {% else %}

                        <div class="alert alert-secondary text-center">
                            Nenhum material encontrado.
                            {% if categoria_selecionada %}
                                Tente limpar o filtro.
                            {% else %}
                                Seja o primeiro a adicionar um material!
                            {% endif %}
                        </div>

                    {% endif %}
                </section>

            </div>
        </main>

        {% include 'footer.html' %}

        <!-- FAB -->
        <a href="{{ url_for('main.suporte') }}" class="help-btn help-btn-user">
            <i class="bi bi-headset"></i>
        </a>

        <a href="{{ url_for('main.tela_denuncias') }}" class="help-btn help-btn-admin">
            <i class="bi bi-shield-check"></i>
        </a>

        <!-- MODAL ADICIONAR MATERIAL -->
        <div class="modal fade" id="modalAdicionarMaterial">
            <div class="modal-dialog modal-dialog-centered modal-lg modal-custom-verde">
                <div class="modal-content">

                    <div class="modal-header">
                        <h1 class="modal-title fs-5">Adicionar Novo Material</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">

                        <form id="formAdicionarMaterial" method="POST"
                              action="{{ url_for('main.adicionar_material') }}"
                              enctype="multipart/form-data">

                            <div class="mb-3">
                                <label class="form-label fw-bold">Título do Material:</label>
                                <input type="text" class="form-control" name="materialTitulo"
                                       placeholder="Ex: Lista de Exercícios de Python" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Breve Descrição (Opcional):</label>
                                <textarea class="form-control" name="materialDescricao"
                                          rows="3" maxlength="150"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold"><i class="bi bi-paperclip"></i> Arquivo:</label>
                                <input class="form-control" type="file" name="materialArquivo" required>
                            </div>

                            <hr>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-folder-check"></i> Escolher Categoria Existente
                                    </label>
                                    <select name="materialCategoriaExistente" class="form-select">
                                        <option value="">Selecione...</option>

                                        {% for cat in categorias %}
                                        <option value="{{ cat }}">{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-folder-plus"></i> ...Ou Criar Nova Categoria
                                    </label>
                                    <input type="text" class="form-control" name="materialCategoriaNova"
                                           placeholder="Ex: História">
                                </div>
                            </div>

                            <small class="text-muted">
                                Se preencher os dois, a nova categoria será usada.
                            </small>

                    </div>

                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>

                        <button type="submit" class="btn btn-primary filter-btn">
                            Publicar Material
                        </button>
                    </div>

                        </form>
                </div>
            </div>
        </div>

    </div>
    <div vw class="enabled">
        <div vw-access-button class="active"></div>
        <div vw-plugin-wrapper>
          <div class="vw-plugin-top-wrapper"></div>
        </div>
      </div>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script>
        new window.VLibras.Widget('https://vlibras.gov.br/app');
    </script>
    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
  // --- Lógica de Acessibilidade ---

  // 1. Abrir/Fechar Menu
  function toggleAccessMenu() {
    const menu = document.getElementById('access-menu');
    menu.classList.toggle('show');
  }

  // 2. Alto Contraste
  function toggleContrast() {
    document.body.classList.toggle('high-contrast');
    if (document.body.classList.contains('high-contrast')) {
      localStorage.setItem('contrast', 'true');
    } else {
      localStorage.removeItem('contrast');
    }
  }

  // Verifica preferência salva
  if (localStorage.getItem('contrast') === 'true') {
    document.body.classList.add('high-contrast');
  }

  // 3. Controle de Fonte
  let currentFontSize = 100; 

  function increaseFont() {
    if (currentFontSize < 150) {
      currentFontSize += 10;
      document.body.style.fontSize = currentFontSize + '%';
    }
  }

  function decreaseFont() {
    if (currentFontSize > 80) {
      currentFontSize -= 10;
      document.body.style.fontSize = currentFontSize + '%';
    }
  }

  function resetAccess() {
    currentFontSize = 100;
    document.body.style.fontSize = '100%';
    document.body.classList.remove('high-contrast');
    localStorage.removeItem('contrast');
  }
</script>
  <div id="access-menu" class="access-menu-container">
    <h6 class="mb-3 border-bottom pb-2">Acessibilidade</h6>
    <div class="d-grid gap-2">
      <button class="btn btn-sm btn-outline-dark d-flex justify-content-between align-items-center" onclick="toggleContrast()">
        <span>Alto Contraste</span>
        <i class="bi bi-circle-half"></i>
      </button>
      <div class="btn-group" role="group">
        <button class="btn btn-sm btn-outline-dark" onclick="increaseFont()">
          <i class="bi bi-zoom-in"></i> Aumentar
        </button>
        <button class="btn btn-sm btn-outline-dark" onclick="decreaseFont()">
          <i class="bi bi-zoom-out"></i> Diminuir
        </button>
      </div>
      <button class="btn btn-sm btn-outline-danger" onclick="resetAccess()">
        <i class="bi bi-arrow-counterclockwise"></i> Resetar
      </button>
    </div>
  </div>

  <button class="btn-access-float" onclick="toggleAccessMenu()" title="Opções de Acessibilidade">
    <i class="bi bi-universal-access"></i>
  </button>
</body>
</html>
