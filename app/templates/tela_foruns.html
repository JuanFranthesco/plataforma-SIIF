{% extends 'base.html' %}

{% block title %}
    Fórum | {{ super() }}
{% endblock %}

{% block body_class %}
    {% if current_user.is_admin %}role-admin{% else %}role-user{% endif %}
{% endblock %}

{% block content %}
    <div class="page-container">
        <main class="forum-dashboard container-fluid py-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <div class="row g-4">
                <div id="sidebar-wrapper" class="col-lg-3 d-none d-lg-block">
                    <div class="p-3">
                        <div class="d-flex justify-content-end mb-2">
                            <button id="btn-collapse-horizontal" class="btn btn-outline-success btn-sm">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                        </div>
                        <div id="sidebar-content">
                            <div class="forum-left-sidebar card-custom bg-white shadow-sm">
                                <div class="sidebar-header mb-2">
                                    <h5 class="mb-0 fw-bold text-success">Menu Fórum</h5>
                                </div>
                                <div class="sidebar-menu">
                                    <a href="{{ url_for('main.tela_foruns') }}" class="sidebar-link {% if not filtro_selecionado == 'salvos' %}active{% endif %}">
                                        <i class="bi bi-house-door-fill"></i>
                                        <span>Feed</span>
                                    </a>
                                    <a href="{{ url_for('main.tela_perfil') }}" class="sidebar-link">
                                        <i class="bi bi-person-circle"></i>
                                        <span>Perfil</span>
                                    </a>
                                    <a href="#" class="sidebar-link d-flex justify-content-between align-items-center" data-bs-toggle="modal" data-bs-target="#modalNotificacoes">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-bell-fill"></i>
                                            <span class="truncate">Notificações</span>
                                        </div>
                                        <span class="notification-badge">3</span>
                                    </a>
                                    <a href="{{ url_for('main.tela_foruns', filtro='salvos') }}" class="sidebar-link {% if filtro_selecionado == 'salvos' %}active{% endif %}">
                                        <i class="bi bi-bookmark-fill"></i>
                                        <span>Posts salvos</span>
                                    </a>  
                                </div>
                                <div class="mt-4 px-0 pb-3">
                                    <button type="button" class="btn btn-success w-100 fw-bold rounded-pill shadow-sm" data-bs-toggle="modal" data-bs-target="#modalPostar">
                                        <i class="bi bi-plus-lg me-1"></i> Novo Post
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8 col-md-12 posts-wrapper">
                    <div class="d-flex align-items-center mb-3">
                        <div class="d-flex align-items-center mx-auto gap-2">
                            <button id="open-sidebar-btn" class="btn btn-outline-success d-lg-none me-2" title="Abrir menu">
                                <i class="bi bi-list"></i>
                            </button>
                            <form class="mb-0" method="GET" action="{{ url_for('main.tela_foruns') }}">
                                <div class="input-group search-card-wrapper shadow-sm rounded-pill overflow-hidden bg-white">
                                    <input type="text" class="form-control border-0 ps-4 py-3" placeholder="Buscar no fórum..." name="q" value="{{ termo_pesquisado or '' }}" aria-label="Buscar no fórum">
                                    <button class="btn btn-white border-start text-success" type="button" data-bs-toggle="modal" data-bs-target="#modalFiltros" aria-controls="modalFiltros">
                                        <i class="bi bi-sliders"></i>
                                    </button>
                                    <button class="btn btn-success px-4" type="submit"><i class="bi bi-search"></i></button>
                                </div>
                            </form>
                        </div>
                        <div class="d-none d-md-block">
                            <button class="btn btn-success rounded-pill" data-bs-toggle="modal" data-bs-target="#modalPostar">
                                <i class="bi bi-plus-lg me-1"></i> Novo Post
                            </button>
                        </div>
                    </div>
                    {% for topico in topicos %}
                    <article class="forum-post-card card-custom mb-4 bg-white shadow-sm">
                        <div class="post-header">
                            <a href="#" class="d-flex align-items-center gap-3 text-decoration-none" data-bs-toggle="modal" data-bs-target="#modalVerPerfil"
                                data-user-name="{{ topico.autor.name }}"
                                data-user-bio="{% if topico.autor.perfil %}{{ topico.autor.perfil.bio }}{% else %}Estudante do IFRN{% endif %}"
                                data-user-curso="{% if topico.autor.perfil %}{{ topico.autor.perfil.curso }}{% else %}Curso não informado{% endif %}"
                                data-user-campus="{% if topico.autor.perfil %}{{ topico.autor.perfil.campus }}{% else %}IFRN{% endif %}">
                                <img class="contact-avatar" src="https://placehold.co/45x45/386641/fff?text={{ topico.autor.name[0] }}" alt="Avatar">
                                <div class="d-flex flex-column">
                                    <h3 class="post-author text-dark mb-0">{{ topico.autor.name }}</h3>
                                    <small class="text-muted" style="font-size: 0.75rem;">Postado recentemente</small>
                                </div>
                            </a>
                            <div class="post-options-container">
                                <input type="checkbox" id="post-options-{{ topico.id }}" class="comment-options-toggle">
                                <label for="post-options-{{ topico.id }}" class="post-options-btn">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </label>
                                <div class="comment-options-menu shadow">
                                    <form action="{{ url_for('main.salvar_post', topico_id=topico.id) }}" method="POST">
                                        <button type="submit" class="comment-option-item w-100 text-start btn-reset">
                                            <i class="bi bi-bookmark"></i> <span>{% if topico.id in salvos_usuario %}Remover{% else %}Salvar{% endif %}</span>
                                        </button>
                                    </form>
                                    <button type="button" class="comment-option-item w-100 text-start btn-reset text-danger" data-bs-toggle="modal" data-bs-target="#modalDenunciar" data-bs-topico-id="{{ topico.id }}">
                                        <i class="bi bi-flag"></i> <span>Denunciar</span>
                                    </button>
                                    {% if current_user.is_admin or topico.autor_id == current_user.id %}
                                    <div class="dropdown-divider"></div>
                                    <form action="{{ url_for('main.excluir_post', topico_id=topico.id) }}" method="POST">
                                        <button type="submit" class="comment-option-item w-100 text-start btn-reset text-danger" onclick="return confirm('Excluir post?');">
                                            <i class="bi bi-trash"></i> <span>Excluir</span>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="post-body">
                            <h4 class="fw-bold text-success mb-2" style="font-size: 1.15rem;">{{ topico.titulo }}</h4>
                            <p class="text-secondary">{{ topico.conteudo | replace('\n', '<br>') | safe }}</p>
                        </div>
                        <div class="post-footer">
                            <form action="{{ url_for('main.like_post', topico_id=topico.id) }}" method="POST" class="d-inline">
                                <button class="post-action-pill js-like-btn {% if topico.id in likes_usuario %}active{% endif %}" type="submit">
                                    <i class="bi bi-arrow-up-circle{% if topico.id in likes_usuario %}-fill{% endif %}"></i>
                                    <span class="ms-1">{{ topico.likes|length }}</span>
                                </button>
                            </form>
                            <button class="post-action-pill" type="button" data-bs-toggle="collapse" data-bs-target="#comments-post-{{ topico.id }}">
                                <i class="bi bi-chat"></i>
                                <span class="ms-1">{{ topico.respostas|length }}</span>
                            </button>
                            <button class="post-action-pill ms-auto" onclick="copiarLink(this, event)">
                                <i class="bi bi-share"></i>
                            </button>
                        </div>
                        <div class="collapse comments-section" id="comments-post-{{ topico.id }}">
                            <div class="d-flex justify-content-between align-items-center mb-3 pt-3 border-top">
                                <h6 class="mb-0 fw-bold text-muted">Comentários</h6>
                                <button type="button" class="btn btn-sm btn-outline-success rounded-pill" data-bs-toggle="modal" data-bs-target="#modalComentar" data-bs-topico-id="{{ topico.id }}">
                                    Escrever
                                </button>
                            </div>
                            <div class="vstack gap-3">
                                {% for resposta in topico.respostas %}
                                <div class="single-comment d-flex gap-2 align-items-start">
                                    <img class="contact-avatar-sm" src="https://placehold.co/32x32/eee/999?text={{ resposta.autor.name[0] }}" alt="Avatar">
                                    <div class="comment-bubble bg-light p-2 rounded">
                                        <a href="#" class="comment-author fw-bold text-dark text-decoration-none">{{ resposta.autor.name }}</a>
                                        <p class="mb-0 small">{{ resposta.conteudo }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if not topico.respostas %}
                                <p class="text-center text-muted small py-2">Nenhum comentário ainda.</p>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                    {% if not topicos %}
                    <div class="text-center p-5 empty-state-forum">
                        <i class="bi bi-chat-square-quote text-muted display-4 mb-3"></i>
                        <h3 class="text-muted">Nada por aqui...</h3>
                        <p class="text-muted mb-4">Seja o primeiro a iniciar uma discussão!</p>
                        <button type="button" class="btn btn-success rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#modalPostar">
                            Novo Post
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="modalFiltros" tabindex="-1" aria-labelledby="modalFiltrosLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalFiltrosLabel">Opções de Filtro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column">
                    <form class="flex-grow-1 d-flex flex-column" method="GET" action="{{ url_for('main.tela_foruns') }}">
                        {% if termo_pesquisado %}
                        <input type="hidden" name="q" value="{{ termo_pesquisado }}">
                        {% endif %}
                        <div class="mb-4">
                            <h5 class="sidebar-title">Ordenar por:</h5>
                            <div class="form-check">
                                <input class="form-check-input custom-checkbox" type="radio" name="ordenarPor" value="relevancia" id="check-relevancia-mobile" {% if ordenacao_selecionada == 'relevancia' %}checked{% endif %}>
                                <label class="form-check-label" for="check-relevancia-mobile">Relevância</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input custom-checkbox" type="radio" name="ordenarPor" value="recente" id="check-recente-mobile" {% if not ordenacao_selecionada or ordenacao_selecionada == 'recente' %}checked{% endif %}>
                                <label class="form-check-label" for="check-recente-mobile">Mais recente</label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <h5 class="sidebar-title">Exibir publicações:</h5>
                            <div class="form-check">
                                <input class="form-check-input custom-checkbox" type="checkbox" name="exibir[]" value="professores" id="check-prof-mobile">
                                <label class="form-check-label" for="check-prof-mobile">Professores</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input custom-checkbox" type="checkbox" name="exibir[]" value="estudantes" id="check-estudantes-mobile">
                                <label class="form-check-label" for="check-estudantes-mobile">Estudantes</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input custom-checkbox" type="checkbox" name="exibir[]" value="servidores" id="check-servidores-mobile">
                                <label class="form-check-label" for="check-servidores-mobile">Servidores</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary filter-btn w-100 mt-auto">Aplicar Filtros</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalComentar" tabindex="-1" aria-labelledby="modalComentarLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-custom-verde">
            <form class="modal-content" id="formComentario" action="" method="POST">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="modalComentarLabel">Escrever Comentário</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" rows="5" placeholder="No que está pensando?" aria-label="Campo para escrever seu comentário" name="conteudo_comentario" required></textarea>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-link" style="color: #386641; text-decoration: none;"><i class="bi bi-paperclip"></i> Anexar Mídia</button>
                    <button type="submit" class="btn btn-primary filter-btn">Comentar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="modalPostar" tabindex="-1" aria-labelledby="modalPostarLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-custom-verde">
            <form class="modal-content" action="{{ url_for('main.criar_post') }}" method="POST">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="modalPostarLabel">Criar Novo Post</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" rows="5" placeholder="No que está pensando?" aria-label="Campo para escrever sua postagem" name="conteudo_post" required></textarea>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-link" style="color: #386641; text-decoration: none;"><i class="bi bi-paperclip"></i> Anexar Mídia</button>
                    <button type="submit" class="btn btn-primary filter-btn">Postar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="modalNotificacoes" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-custom-verde">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Notificações</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Sem novas notificações.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalVerPerfil" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-custom-verde">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Perfil do Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="https://placehold.co/100x100" class="rounded-circle mb-3" alt="User">
                    <h4>Nome do Usuário</h4>
                    <p class="text-muted">Biografia do usuário...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDenunciar" tabindex="-1" aria-labelledby="modalDenunciarLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-custom-verde">
            <form class="modal-content" id="formDenuncia" action="" method="POST">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="modalDenunciarLabel">Denunciar Post</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Por favor, descreva o motivo da sua denúncia.</p>
                    <textarea class="form-control" rows="4" placeholder="Motivo da denúncia..." name="descricao" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger"><i class="bi bi-flag-fill"></i> Enviar Denúncia</button>
                </div>
            </form>
        </div>
    </div>

    <a href="{{ url_for('main.suporte') }}" class="help-btn help-btn-user" title="Suporte">
        <i class="bi bi-headset"></i>
    </a>
    <a href="{{ url_for('main.tela_denuncias') }}" class="help-btn help-btn-admin" title="Denúncias (admin)">
        <i class="bi bi-shield-check"></i>
    </a>

{% endblock %}
{% block scripts %}

    <script>
        // ===== SIDEBAR HORIZONTAL (ESTILO REDDIT) =====
        (function () {
            const sidebar = document.getElementById("sidebar-wrapper");
            const btn = document.getElementById("btn-collapse-horizontal");
            const posts = document.querySelector(".posts-wrapper");

            if (!sidebar || !btn || !posts) return;

            btn.addEventListener("click", () => {
                const isCollapsed = sidebar.classList.contains("collapsed-horizontal");
                const icon = btn.querySelector("i"); // pega o ícone dentro do botão

                if (isCollapsed) {
                    // EXPANDIR
                    posts.classList.add("posts-freeze");
                    sidebar.classList.remove("collapsed-horizontal");

                    // trocar ícone
                    if (icon) icon.classList.replace("bi-chevron-right", "bi-chevron-left");

                    setTimeout(() => {
                        posts.classList.remove("posts-freeze");
                    }, 260);
                } else {
                    // RECOLHER
                    sidebar.classList.add("collapsed-horizontal");

                    // trocar ícone
                    if (icon) icon.classList.replace("bi-chevron-left", "bi-chevron-right");
                }
            });
        })();

        (function () {
            // Modal: Comentário dinamico
            const modalComentar = document.getElementById('modalComentar');
            if (modalComentar) {
                const formComentario = document.getElementById('formComentario');
                modalComentar.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    if (!button) return;
                    const topicoId = button.getAttribute('data-bs-topico-id');
                    if (topicoId && formComentario) {
                        formComentario.setAttribute('action', `/forum/${topicoId}/comentar`);
                    }
                });
            }

            // Modal: Denunciar dinamico (set action)
            const modalDenunciar = document.getElementById('modalDenunciar');
            if (modalDenunciar) {
                const formDenuncia = document.getElementById('formDenuncia');
                modalDenunciar.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    if (!button) return;
                    const topicoId = button.getAttribute('data-bs-topico-id');
                    if (topicoId && formDenuncia) {
                        formDenuncia.setAttribute('action', `/forum/${topicoId}/denunciar`);
                    }
                });
            }

            // Modal: Ver Perfil (dinâmico)
            const modalVerPerfil = document.getElementById('modalVerPerfil');
            if (modalVerPerfil) {
                modalVerPerfil.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    if (!button) return;
                    const nome = button.getAttribute('data-user-name') || '';
                    const bio = button.getAttribute('data-user-bio') || '';
                    const curso = button.getAttribute('data-user-curso') || '';
                    const campus = button.getAttribute('data-user-campus') || '';
                    const modalTitle = modalVerPerfil.querySelector('.modal-body h4');
                    const modalBio = modalVerPerfil.querySelector('.modal-body p');
                    const modalImg = modalVerPerfil.querySelector('.modal-body img');
                    if (modalTitle) modalTitle.textContent = nome;
                    if (modalBio) modalBio.textContent = bio + (curso ? ' • ' + curso : '') + (campus ? ' • ' + campus : '');
                    if (modalImg && nome) modalImg.src = `https://placehold.co/100x100/386641/fff?text=${encodeURIComponent(nome.charAt(0))}`;
                });
            }

            // Copiar link (compartilhar)
            window.copiarLink = function (botao, event) {
                event.preventDefault();
                const url = window.location.href;
                if (!navigator.clipboard) {
                    alert('API de clipboard não disponível');
                    return;
                }
                navigator.clipboard.writeText(url).then(function () {
                    // feedback
                    const original = botao.innerHTML;
                    botao.innerHTML = '<i class="bi bi-check-lg"></i>';
                    botao.classList.add('text-success');
                    setTimeout(function () {
                        botao.innerHTML = original;
                        botao.classList.remove('text-success');
                    }, 2000);
                }).catch(function (err) {
                    console.error('Erro ao copiar link: ', err);
                });
            };
        })();
    </script>
{% endblock %}